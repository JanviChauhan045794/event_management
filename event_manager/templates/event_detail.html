{% extends "attendee/base.html" %}
{% load custom_filters %}

{% block title %}{{ event.title }} - Event Manager{% endblock %}

{% block extra_head %}
<meta property="og:title" content="{{ event.title }}" />
<meta property="og:description" content="{{ event.description|truncatewords:50 }}" />
{% if event.banner %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ event.banner.url }}" />
{% endif %}
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
{% endblock %}

{% block content %}
<!-- Event Detail Main Container -->
<div class="container-fluid py-4 px-lg-5 event-detail-container">
    {% if messages %}
        <div class="messages-container mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Top Navigation Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4 top-nav-container">
        <div class="animate__animated animate__fadeInLeft" style="animation-delay: 0.2s">
            {% if is_organizer %}
            <a href="{% url 'my_events' %}" class="btn btn-outline-primary rounded-pill">
                <i class="fas fa-arrow-left me-2"></i>Back to My Events
            </a>
            {% elif is_attendee %}
            <a href="{% url 'attendee_dashboard' %}" class="btn btn-outline-primary rounded-pill">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            {% endif %}
        </div>

        <div class="animate__animated animate__fadeInRight" style="animation-delay: 0.2s">
            {% if is_organizer or user_registration %}
            <a href="{% url 'event_pdf' event.event_id %}" class="btn btn-outline-danger rounded-pill">
                <i class="fas fa-file-pdf me-2"></i>{% if user_registration and not is_organizer %}Download Ticket{% else %}Download PDF{% endif %}
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4 animate__animated animate__fadeIn" style="animation-delay: 0.3s">
        <ol class="breadcrumb bg-light py-2 px-3 rounded shadow-sm">
            <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none">Home</a></li>
            {% if is_organizer %}
                <li class="breadcrumb-item"><a href="{% url 'organizer_dashboard' %}" class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'my_events' %}" class="text-decoration-none">My Events</a></li>
            {% else %}
                <li class="breadcrumb-item"><a href="{% url 'attendee_dashboard' %}" class="text-decoration-none">Dashboard</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ event.title }}</li>
        </ol>
    </nav>

    <!-- Event Header Section -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-3 animate__animated animate__fadeInDown">
        {% if event.banner %}
            <div class="event-banner position-relative animate__animated animate__fadeIn">
                <div class="overlay-hero" style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('{{ event.banner.url }}') no-repeat center center; background-size: cover; height: 300px;"></div>
                <div class="position-absolute bottom-0 start-0 w-100 p-3 text-white">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-end flex-wrap">
                            <div class="animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <span class="badge bg-primary rounded-pill px-3 py-2">{{ event.category.name }}</span>
                                    {% if event.ticket_price > 0 %}
                                        <span class="badge bg-success rounded-pill px-3 py-2">₹{{ event.ticket_price }}</span>
                                    {% else %}
                                        <span class="badge bg-success rounded-pill px-3 py-2">Free</span>
                                    {% endif %}

                                    <!-- Event Status Badge -->
                                    {% if event.start_date > today %}
                                        <span class="badge bg-warning text-dark rounded-pill px-3 py-2">Upcoming</span>
                                    {% elif event.end_date < today %}
                                        <span class="badge bg-secondary rounded-pill px-3 py-2">Past</span>
                                    {% else %}
                                        <span class="badge bg-danger rounded-pill px-3 py-2">Happening Now</span>
                                    {% endif %}
                                </div>
                                <h1 class="display-5 fw-bold mb-3 text-break text-shadow">{{ event.title }}</h1>

                                <div class="d-flex flex-wrap align-items-center gap-3 mt-3 animate__animated animate__fadeIn" style="animation-delay: 0.5s">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        <span>{{ event.start_date|date:"M d, Y" }}{% if event.end_date and event.end_date != event.start_date %} - {{ event.end_date|date:"M d, Y" }}{% endif %}</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock me-2"></i>
                                        <span>{{ event.start_time|time:"g:i A" }}{% if event.end_time %} - {{ event.end_time|time:"g:i A" }}{% endif %}</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        <span>{{ event.location }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 mt-md-0 animate__animated animate__fadeInRight" style="animation-delay: 0.4s">
                                {% if is_organizer %}
                                    <div class="btn-group">
                                        <a href="{% url 'edit_event' event.event_id %}" class="btn btn-light shadow-sm">
                                            <i class="fas fa-edit me-2"></i>Edit Event
                                        </a>
                                        <button type="button" class="btn btn-light shadow-sm" data-bs-toggle="modal" data-bs-target="#emailAttendeesModal">
                                            <i class="fas fa-envelope me-2"></i>Email Attendees
                                        </button>
                                    </div>
                                {% elif user_registration %}
                                    <button class="btn btn-success shadow-sm">
                                        <i class="fas fa-check-circle me-2"></i>Registered
                                    </button>
                                {% else %}
                                    <a href="{% url 'register_event' event.event_id %}" class="btn btn-primary btn-lg shadow-sm animate__animated animate__pulse animate__infinite animate__slower">
                                        <i class="fas fa-user-plus me-2"></i>Register Now
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card-body p-5 animate__animated animate__fadeIn">
                <div class="d-flex justify-content-between align-items-start flex-wrap">
                    <div class="animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="badge bg-primary rounded-pill px-3 py-2">{{ event.category.name }}</span>
                            {% if event.ticket_price > 0 %}
                                <span class="badge bg-success rounded-pill px-3 py-2">₹{{ event.ticket_price }}</span>
                            {% else %}
                                <span class="badge bg-success rounded-pill px-3 py-2">Free</span>
                            {% endif %}

                            <!-- Event Status Badge -->
                            {% if event.start_date > today %}
                                <span class="badge bg-warning text-dark rounded-pill px-3 py-2">Upcoming</span>
                            {% elif event.end_date < today %}
                                <span class="badge bg-secondary rounded-pill px-3 py-2">Past</span>
                            {% else %}
                                <span class="badge bg-danger rounded-pill px-3 py-2">Happening Now</span>
                            {% endif %}
                        </div>
                        <h1 class="display-5 fw-bold mb-3 text-break">{{ event.title }}</h1>

                        <div class="d-flex flex-wrap align-items-center gap-3 mt-4 text-muted animate__animated animate__fadeIn" style="animation-delay: 0.5s">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span>{{ event.start_date|date:"M d, Y" }}{% if event.end_date and event.end_date != event.start_date %} - {{ event.end_date|date:"M d, Y" }}{% endif %}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-2"></i>
                                <span>{{ event.start_time|time:"g:i A" }}{% if event.end_time %} - {{ event.end_time|time:"g:i A" }}{% endif %}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                <span>{{ event.location }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 mt-md-0 animate__animated animate__fadeInRight" style="animation-delay: 0.4s">
                        {% if is_organizer %}
                            <a href="{% url 'edit_event' event.event_id %}" class="btn btn-primary shadow-sm">
                                <i class="fas fa-edit me-2"></i>Edit Event
                            </a>
                        {% elif user_registration %}
                            <button class="btn btn-success shadow-sm">
                                <i class="fas fa-check-circle me-2"></i>Registered
                            </button>
                        {% else %}
                            <a href="{% url 'register_event' event.event_id %}" class="btn btn-primary btn-lg shadow-sm animate__animated animate__pulse animate__infinite animate__slower">
                                <i class="fas fa-user-plus me-2"></i>Register Now
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Event Quick Stats -->
        <div class="card-body {% if event.banner %}bg-light{% endif %} border-top event-stats-section">
            <div class="row g-2 animate__animated animate__fadeIn" style="animation-delay: 0.5s">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card shadow-sm rounded p-2 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary bg-opacity-10 rounded-circle p-3 me-3 animate__animated animate__bounceIn" style="animation-delay: 0.7s">
                                <i class="fas fa-calendar-day text-primary animate__animated animate__pulse animate__infinite animate__slower"></i>
                            </div>
                            <div>
                                <p class="text-muted small mb-0">Starts</p>
                                <div class="fw-bold">{{ event.start_date|date:"F d, Y" }}</div>
                                <div class="small text-muted">{{ event.start_time|time:"g:i A" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card shadow-sm rounded p-2 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-danger bg-opacity-10 rounded-circle p-3 me-3 animate__animated animate__bounceIn" style="animation-delay: 0.8s">
                                <i class="fas fa-calendar-check text-danger animate__animated animate__pulse animate__infinite animate__slower"></i>
                            </div>
                            <div>
                                <p class="text-muted small mb-0">Ends</p>
                                <div class="fw-bold">{{ event.end_date|date:"F d, Y" }}</div>
                                <div class="small text-muted">{{ event.end_time|time:"g:i A" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card shadow-sm rounded p-2 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-success bg-opacity-10 rounded-circle p-3 me-3 animate__animated animate__bounceIn" style="animation-delay: 0.9s">
                                <i class="fas fa-map-marker-alt text-success animate__animated animate__pulse animate__infinite animate__slower"></i>
                            </div>
                            <div>
                                <p class="text-muted small mb-0">Location</p>
                                <div class="fw-bold text-truncate" style="max-width: 150px;" title="{{ event.location }}">{{ event.location }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card shadow-sm rounded p-2 bg-white">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-info bg-opacity-10 rounded-circle p-3 me-3 animate__animated animate__bounceIn" style="animation-delay: 1s">
                                <i class="fas fa-users text-info animate__animated animate__pulse animate__infinite animate__slower"></i>
                            </div>
                            <div>
                                <p class="text-muted small mb-0">Attendees</p>
                                <div class="fw-bold">{{ attendees_count }} attending</div>
                                <div class="small text-muted">{{ speakers_count }} speakers</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Capacity Information -->
            {% if event.capacity > 0 %}
            <div class="mt-2 pt-2 border-top animate__animated animate__fadeIn" style="animation-delay: 0.7s">
                <div class="card shadow-sm rounded p-2 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0 fw-bold">Event Capacity</h6>
                            <span class="badge {% if event.is_full %}bg-danger{% else %}bg-success{% endif %} mt-2">
                                {% if event.is_full %}Full{% else %}{{ event.get_available_seats }} seats available{% endif %}
                            </span>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted mb-1">Seats Filled</div>
                            <div class="fw-bold">{{ attendees_count }} / {{ event.capacity }}</div>
                        </div>
                    </div>
                    <div class="progress animate__animated animate__fadeInLeft" style="height: 10px; border-radius: 5px; animation-delay: 0.9s">
                        <div class="progress-bar {% if event.is_full %}bg-danger{% else %}bg-success{% endif %}" role="progressbar"
                            style="width: {% if event.capacity > 0 %}{{ attendees_count|multiply:100|div:event.capacity|floatformat:0 }}{% else %}0{% endif %}%;"
                            aria-valuenow="{% if event.capacity > 0 %}{{ attendees_count|multiply:100|div:event.capacity|floatformat:0 }}{% else %}0{% endif %}"
                            aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">0%</small>
                        <small class="text-muted">50%</small>
                        <small class="text-muted">100%</small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 event-detail-content">
        <!-- Main Content Column -->
        <div class="col-lg-8">
            <!-- Event Description Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInLeft main-content-card" style="animation-delay: 0.3s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-align-left text-primary"></i>
                        </div>
                        About This Event
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="event-description">
                        {{ event.description|linebreaks }}
                    </div>

                    {% if event_speakers %}
                    <div class="mt-3 pt-3 border-top">
                        <h5 class="mb-2"><i class="fas fa-microphone text-primary me-2"></i>Event Speakers</h5>
                        <div class="row g-3">
                            {% for event_speaker in event_speakers %}
                            <div class="col-md-6">
                                <div class="card h-100 border {% if event_speaker.is_keynote %}border-warning{% else %}border-light{% endif %} rounded-3">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="speaker-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 50px; height: 50px; font-size: 18px;">
                                                {{ event_speaker.speaker.user.first_name|first }}{{ event_speaker.speaker.user.last_name|first }}
                                            </div>
                                            <div class="speaker-info">
                                                <h6 class="mb-0 fw-bold text-break">{{ event_speaker.speaker.user.first_name }} {{ event_speaker.speaker.user.last_name }}</h6>
                                                <div class="small text-muted mt-1">
                                                    {% if event_speaker.is_keynote %}
                                                    <span class="badge bg-warning text-dark">Keynote Speaker</span>
                                                    {% else %}
                                                    <span class="badge bg-info">Speaker</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% if event_speaker.topic %}
                                        <div class="speaker-topic mt-3 pt-2 border-top">
                                            <div class="small text-muted mb-1 fw-bold">Topic:</div>
                                            <p class="mb-0 text-break">{{ event_speaker.topic }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if event.registration_link %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2">External Registration</h6>
                        <a href="{% if event.registration_link|slice:':4' == 'http' %}{{ event.registration_link }}{% else %}{{ request.scheme }}://{{ request.get_host }}{{ event.registration_link }}{% endif %}" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt me-2"></i>Register on Event Website
                        </a>
                    </div>
                    {% endif %}

                    <!-- Action Buttons Section -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row g-2 action-buttons">
                            {% if not user_registration and not is_organizer %}
                                <div class="col-md-6">
                                    <a href="{% url 'register_event' event.event_id %}" class="btn btn-primary d-block">
                                        <i class="fas fa-user-plus me-2"></i>Register for This Event
                                    </a>
                                </div>
                            {% endif %}

                            <div class="col-md-6">
                                <div class="dropdown w-100">
                                    <button class="btn btn-outline-primary d-block w-100 dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-share-alt me-2"></i>Share Event
                                    </button>
                                    <ul class="dropdown-menu w-100 shadow-sm" aria-labelledby="shareDropdown">
                                        <li><a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;"><i class="fas fa-envelope text-primary me-2"></i>Email</a></li>
                                        <li><a class="dropdown-item" href="#" data-share-platform="facebook"><i class="fab fa-facebook text-primary me-2"></i>Facebook</a></li>
                                        <li><a class="dropdown-item" href="#" data-share-platform="twitter"><i class="fab fa-twitter text-info me-2"></i>Twitter</a></li>
                                        <li><a class="dropdown-item" href="#" data-share-platform="whatsapp"><i class="fab fa-whatsapp text-success me-2"></i>WhatsApp</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><button class="dropdown-item" onclick="copyEventLink()"><i class="fas fa-copy text-secondary me-2"></i>Copy Link</button></li>
                                    </ul>
                                </div>
                            </div>

                            {% if user_registration and not is_organizer %}
                                <div class="col-md-6">
                                    <a href="#feedbackModal" data-bs-toggle="modal" class="btn btn-outline-warning d-block">
                                        <i class="fas fa-star me-2"></i>Leave Feedback
                                    </a>
                                </div>
                            {% endif %}

                            {% if is_organizer %}
                                <div class="col-md-6">
                                    <a href="{% url 'edit_event' event.event_id %}" class="btn btn-outline-primary d-block">
                                        <i class="fas fa-edit me-2"></i>Edit Event
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="#emailAttendeesModal" data-bs-toggle="modal" class="btn btn-outline-info d-block">
                                        <i class="fas fa-paper-plane me-2"></i>Email Attendees
                                    </a>
                                </div>
                                <div class="col-md-6 mt-2">
                                    <a href="{% url 'event_pdf' event.event_id %}" class="btn btn-outline-danger d-block">
                                        <i class="fas fa-file-pdf me-2"></i>Download Event PDF
                                    </a>
                                </div>
                            {% endif %}

                            <!-- Add Share Registration Link button in the action buttons section -->
                            <div class="d-grid mb-3">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#shareRegistrationModal">
                                    <i class="fas fa-share-alt me-2"></i>Share Registration Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Status & Reminders Section -->
            {% if user_registration %}
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInLeft main-content-card" style="animation-delay: 0.5s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-calendar-check text-success"></i>
                        </div>
                        Your Registration Status
                    </h5>
                </div>
                <div class="card-body p-3">
                    {% if user_registration.status == 'cancelled' %}
                    <div class="alert alert-danger d-flex align-items-center mb-3">
                        <i class="fas fa-ban fa-2x me-3"></i>
                        <div>
                            <p class="fw-bold mb-1">Registration Cancelled</p>
                            <p class="mb-0 small">You have cancelled your registration for this event.</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-success d-flex align-items-center mb-3">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <p class="fw-bold mb-1">You're registered for this event!</p>
                            <p class="mb-0 small">Your ticket information has been sent to your email.</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="reminderSwitch" {% if user_registration.reminders_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="reminderSwitch">Receive email reminders about this event</label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="updatesSwitch" {% if user_registration.updates_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="updatesSwitch">Receive updates if this event changes</label>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            {% if user_registration.status != 'cancelled' %}
                            <a href="{% url 'event_pdf' event.event_id %}" class="btn btn-danger" target="_blank">
                                <i class="fas fa-file-pdf me-2"></i>Download Ticket
                            </a>
                            <a href="{% url 'event_pdf' event.event_id %}" class="btn btn-outline-primary ms-2" target="_blank">
                                <i class="fas fa-eye me-2"></i>View Ticket
                            </a>
                            {% else %}
                            <div class="text-danger">
                                <i class="fas fa-ban me-2"></i>Ticket not available
                            </div>
                            {% endif %}
                        </div>
                        {% if user_registration.status != 'cancelled' %}
                        <button class="btn btn-outline-danger" id="cancelRegistrationBtn" data-event-id="{{ event.event_id }}">
                            <i class="fas fa-times-circle me-2"></i>Cancel Registration
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if feedback.exists %}
            <!-- Feedback Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInLeft main-content-card" style="animation-delay: 0.7s">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        Attendee Feedback
                    </h5>
                    {% if not user_feedback and user_registration %}
                    <button class="btn btn-sm btn-outline-primary rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                        <i class="fas fa-plus me-1"></i>Add Feedback
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                    {% for f in feedback %}
                        <li class="list-group-item p-4 border-bottom">
                            <div class="d-flex justify-content-between mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        {{ f.user.first_name|first }}{{ f.user.last_name|first }}
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ f.user.first_name }} {{ f.user.last_name }}</h6>
                                        <div class="feedback-rating">
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= f.rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-muted small">{{ f.feedback_id|date:"M d, Y" }}</div>
                            </div>
                            <div class="ms-5 ps-2">
                                <p class="mb-0">{{ f.comments }}</p>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {% if is_organizer %}
            <!-- Attendees List Card (Visible only to organizers) -->
            <div class="card border-0 shadow-sm rounded-4 animate__animated animate__fadeInLeft main-content-card" style="animation-delay: 0.9s">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-user-check text-primary"></i>
                        </div>
                        Registered Attendees
                    </h5>
                    <div>
                        <a href="{% url 'export_registrations_csv' event.event_id %}" class="btn btn-sm btn-outline-primary rounded-pill shadow-sm me-2">
                            <i class="fas fa-download me-1"></i>Export CSV
                        </a>
                        <a href="{% url 'email_attendees' event.event_id %}" class="btn btn-sm btn-outline-info rounded-pill shadow-sm">
                            <i class="fas fa-envelope me-1"></i>Email All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                <tr>
                                    <td class="ps-4">{{ registration.user.first_name }} {{ registration.user.last_name }}</td>
                                    <td>{{ registration.user.email }}</td>
                                    <td>
                                        <span class="badge {% if registration.role.name == 'attendee' %}bg-primary{% elif registration.role.name == 'speaker' %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                                            {{ registration.role.name|title }}
                                        </span>
                                    </td>
                                    <td>{{ registration.attendee_type.name|title|default:"-" }}</td>
                                    <td>{{ registration.registered_at|date:"M d, Y" }}</td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                            <p class="mb-3">No attendees registered yet</p>
                                            <button class="btn btn-primary">
                                                <i class="fas fa-share me-2"></i>Share Event
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Column -->
        <div class="col-lg-4">
            <!-- Organizer Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInRight sidebar-card" style="animation-delay: 0.3s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-user-tie text-primary"></i>
                        </div>
                        Event Organizer
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="organizer-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px; font-size: 24px;">
                            {{ event.organizer.first_name|first }}{{ event.organizer.last_name|first }}
                        </div>
                        <div class="organizer-info">
                            <h5 class="mb-1 text-break">{{ event.organizer.first_name }} {{ event.organizer.last_name }}</h5>
                            <p class="text-muted mb-2 text-break">{{ event.organizer.email }}</p>
                            <a href="#contactModal" data-bs-toggle="modal" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-envelope me-1"></i>Contact
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Card (Only visible if not registered) -->
            {% if not user_registration and not is_organizer %}
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInRight sidebar-card" style="animation-delay: 0.5s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-ticket-alt text-success"></i>
                        </div>
                        Registration
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Price</span>
                            <span class="fw-bold">
                                {% if event.ticket_price > 0 %}
                                    ${{ event.ticket_price }}
                                {% else %}
                                    Free
                                {% endif %}
                            </span>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Availability</span>
                            <span class="badge bg-success">Open</span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <span>Registration Closes</span>
                            <span class="fw-bold">{{ event.start_date|date:"M d, Y" }}</span>
                        </div>
                    </div>

                    <div class="d-grid">
                        {% if now >= event.start_date %}
                            <button class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-clock me-2"></i>Registration Closed
                            </button>
                        {% else %}
                        <a href="{% url 'register_event' event.event_id %}" class="btn btn-primary btn-lg shadow-sm animate__animated animate__pulse animate__infinite animate__slower">
                            <i class="fas fa-user-plus me-2"></i>Register Now
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Event Link Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInRight sidebar-card" style="animation-delay: 0.7s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-link text-primary"></i>
                        </div>
                        Event Link
                    </h5>
                </div>
                <div class="card-body p-3">
                    <p class="text-muted small mb-2">Share this direct link with others:</p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control text-truncate" value="{{ request.build_absolute_uri }}" id="eventLink" readonly title="{{ request.build_absolute_uri }}">
                        <button class="btn btn-outline-primary" type="button" onclick="copyEventLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>

                    <div class="d-grid">
                        <a href="#shareOptionsModal" data-bs-toggle="modal" class="btn btn-outline-primary">
                            <i class="fas fa-share-alt me-2"></i>More Sharing Options
                        </a>
                    </div>
                </div>
            </div>

            <!-- Add to Calendar Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-3 animate__animated animate__fadeInRight sidebar-card" style="animation-delay: 0.9s">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 rounded-circle me-3 animate__animated animate__bounceIn" style="animation-delay: 0.5s">
                            <i class="fas fa-calendar-plus text-primary"></i>
                        </div>
                        Add to Calendar
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-grid gap-2">
                        <a href="{{ google_calendar_link }}" target="_blank" class="btn btn-outline-danger">
                            <i class="fab fa-google me-2"></i>Google Calendar
                        </a>
                        <a href="{{ outlook_calendar_link }}" target="_blank" class="btn btn-outline-primary">
                            <i class="fab fa-microsoft me-2"></i>Outlook Calendar
                        </a>
                        <a href="{{ ical_download_link }}" class="btn btn-outline-secondary">
                            <i class="fas fa-download me-2"></i>Download iCal File
                        </a>
                    </div>
                </div>
            </div>

            <!-- Additional Info Card -->
            <div class="card border-0 shadow-sm rounded-4 sidebar-card">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Additional Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item px-0 border-0 d-flex justify-content-between">
                            <span>Category</span>
                            <span class="fw-bold">{{ event.category.name }}</span>
                        </li>
                        <li class="list-group-item px-0 border-top d-flex justify-content-between">
                            <span>Date Created</span>
                            <span class="fw-bold">{{ event.event_id|date:"M d, Y" }}</span>
                        </li>
                        <li class="list-group-item px-0 border-top d-flex justify-content-between">
                            <span>Language</span>
                            <span class="fw-bold">English</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Leave Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="feedbackError"></div>
                <div class="alert alert-success d-none" id="feedbackSuccess"></div>
                <form id="feedbackForm" action="{% url 'submit_feedback' event.event_id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3 text-center">
                        <label class="form-label">Rating</label>
                        <div class="rating-stars">
                            <i class="far fa-star fs-3 text-muted rating-star" data-rating="1"></i>
                            <i class="far fa-star fs-3 text-muted rating-star" data-rating="2"></i>
                            <i class="far fa-star fs-3 text-muted rating-star" data-rating="3"></i>
                            <i class="far fa-star fs-3 text-muted rating-star" data-rating="4"></i>
                            <i class="far fa-star fs-3 text-muted rating-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" name="rating" id="rating-value" value="0" required>
                        <div class="rating-text text-muted mt-2"></div>
                        <div class="invalid-feedback">Please select a rating</div>
                    </div>
                    <div class="mb-3">
                        <label for="comments" class="form-label">Comments</label>
                        <textarea class="form-control" id="comments" name="comments" rows="4" placeholder="Share your experience" required></textarea>
                        <div class="invalid-feedback">Please provide your feedback comments</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="feedbackForm" class="btn btn-primary">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Attendees Modal -->
<div class="modal fade" id="emailAttendeesModal" tabindex="-1" aria-labelledby="emailAttendeesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="emailAttendeesModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>Email Attendees
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'email_attendees' event.event_id %}" method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Attendee Count -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This email will be sent to <strong>{{ attendees_count }}</strong> attendee{{ attendees_count|pluralize }} who have enabled notifications.
                    </div>

                    <!-- Subject Field -->
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subject" name="subject" required>
                        <div class="invalid-feedback">
                            Please provide a subject for your email.
                        </div>
                    </div>

                    <!-- Message Field -->
                    <div class="mb-3">
                        <label for="message" class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="message" name="message" rows="6" required></textarea>
                        <div class="invalid-feedback">
                            Please provide a message.
                        </div>
                        <div class="form-text">
                            Write your message to attendees here. Basic formatting is supported.
                        </div>
                    </div>

                    <!-- Include Event Details Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_event_details" name="include_event_details" checked>
                            <label class="form-check-label" for="include_event_details">
                                Include event details in the email
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Send Email to All Attendees
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Event Detail Styles */
    .event-detail-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .event-banner {
        position: relative;
        overflow: hidden;
    }

    .overlay-hero {
        position: relative;
    }

    .text-shadow {
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .social-btn {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .social-btn:hover {
        transform: scale(1.1);
    }

    .rating-stars {
        cursor: pointer;
    }

    .rating-stars .rating-star {
        margin: 0 5px;
        transition: all 0.2s;
    }

    .rating-stars .rating-star:hover,
    .rating-stars .rating-star.active {
        color: #ffc107 !important;
        transform: scale(1.2);
    }

    .event-stats-section {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    .stat-card {
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .invalid-feedback {
        display: none;
        font-size: 0.875rem;
        color: #dc3545;
    }

    .was-validated .form-control:invalid ~ .invalid-feedback,
    .was-validated .form-select:invalid ~ .invalid-feedback,
    .was-validated .form-check-input:invalid ~ .invalid-feedback {
        display: block;
    }

    .was-validated .form-control:invalid,
    .was-validated .form-select:invalid {
        border-color: #dc3545;
    }

    .was-validated .form-check-input:invalid {
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        /* Star rating functionality */
        const stars = document.querySelectorAll('.rating-stars i');
        const ratingInput = document.getElementById('rating-value');
        const ratingText = document.querySelector('.rating-text');
        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackError = document.getElementById('feedbackError');
        const feedbackSuccess = document.getElementById('feedbackSuccess');
        const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];

        /* Star rating functionality */
        stars.forEach(star => {
            star.addEventListener('mouseover', function() {
                const rating = parseInt(this.dataset.rating);
                updateStars(rating);
                ratingText.textContent = ratingTexts[rating - 1];
            });

            star.addEventListener('mouseout', function() {
                const currentRating = parseInt(ratingInput.value) || 0;
                updateStars(currentRating);
                ratingText.textContent = currentRating > 0 ? ratingTexts[currentRating - 1] : '';
            });

            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                ratingInput.value = rating;
                updateStars(rating);
                ratingText.textContent = ratingTexts[rating - 1];
                ratingInput.classList.remove('is-invalid');
                ratingText.classList.remove('text-danger');
            });
        });

        function updateStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'text-warning');
                } else {
                    star.classList.remove('fas', 'text-warning');
                    star.classList.add('far');
                }
            });
        }

        /* Form validation and submission */
        if (feedbackForm) {
            feedbackForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                /* Hide any previous messages */
                feedbackError.classList.add('d-none');
                feedbackSuccess.classList.add('d-none');

                /* Check if rating is selected */
                const rating = ratingInput.value;
                if (!rating || rating === '0') {
                    ratingInput.classList.add('is-invalid');
                    ratingText.classList.add('text-danger');
                    ratingText.textContent = 'Please select a rating';
                    return;
                }

                /* Check if comments are provided */
                const comments = document.getElementById('comments');
                if (!comments.value.trim()) {
                    comments.classList.add('is-invalid');
                    return;
                }

                /* Get the form data */
                const formData = new FormData(this);

                /* Submit the form via AJAX */
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        feedbackSuccess.textContent = data.message;
                        feedbackSuccess.classList.remove('d-none');
                        /* Reset form */
                        this.reset();
                        updateStars(0);
                        ratingText.textContent = '';
                        /* Close the modal after 2 seconds */
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                            modal.hide();
                            /* Reload the page to show the new feedback */
                            window.location.reload();
                        }, 2000);
                    } else {
                        feedbackError.textContent = data.message;
                        feedbackError.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    feedbackError.textContent = 'There was an error submitting your feedback. Please try again.';
                    feedbackError.classList.remove('d-none');
                });
            });

            /* Clear validation state when input changes */
            const comments = document.getElementById('comments');
            comments.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        }

        // Role and attendee type dependency
        const roleSelect = document.getElementById('register-role');
        const typeSelect = document.getElementById('register-type');
        const typeContainer = document.getElementById('attendee-type-container');

        if (roleSelect && typeSelect && typeContainer) {
            // Initially hide the attendee type field
            if (!roleSelect.value || roleSelect.options[roleSelect.selectedIndex]?.text.toLowerCase() !== 'attendee') {
                typeSelect.required = false;
            }

            roleSelect.addEventListener('change', function() {
                if (this.value && this.options[this.selectedIndex].text.toLowerCase() === 'attendee') {
                    typeSelect.required = true;
                    typeContainer.classList.add('required-field');
                    typeContainer.querySelector('.form-text').innerHTML = '<span class="text-danger">Required for attendee role</span>';
                } else {
                    typeSelect.required = false;
                    typeContainer.classList.remove('required-field');
                    typeContainer.querySelector('.form-text').textContent = 'Required for attendees (optional for other roles)';
                }
            });
        }

        // Form validation
        const forms = document.querySelectorAll('.needs-validation');

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                // Special case for rating
                if (form.id === 'feedbackForm') {
                    const ratingValue = document.getElementById('selected_rating').value;
                    if (!ratingValue || ratingValue === '') {
                        event.preventDefault();
                        event.stopPropagation();
                        document.getElementById('rating-text').classList.add('text-danger');
                        document.getElementById('rating-text').textContent = 'Please select a rating';
                    }
                }

                form.classList.add('was-validated');
            }, false);
        });

        // Copy link functions
        window.copyEventLink = function() {
            const linkInput = document.getElementById('eventLink');
            copyLinkToClipboard(linkInput);
        };

        window.copyModalEventLink = function() {
            const linkInput = document.getElementById('shareModalLink');
            copyLinkToClipboard(linkInput);
        };

        window.copyRegistrationLink = function() {
            const linkInput = document.getElementById('registrationLink');
            copyLinkToClipboard(linkInput);
        };

        function copyLinkToClipboard(inputElement) {
            inputElement.select();
            inputElement.setSelectionRange(0, 99999);

            try {
                // Use modern clipboard API if available
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(inputElement.value)
                        .then(() => showCopySuccess(inputElement))
                        .catch(() => {
                            // Fallback to old method
                            document.execCommand('copy');
                            showCopySuccess(inputElement);
                        });
                } else {
                    // Fallback to old method
                    document.execCommand('copy');
                    showCopySuccess(inputElement);
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }

        function showCopySuccess(inputElement) {
            const successDiv = document.getElementById('copySuccess');
            if (successDiv) {
                successDiv.classList.remove('d-none');
                setTimeout(() => {
                    successDiv.classList.add('d-none');
                }, 3000);
            }
        }

        // Email Attendees Form Validation
        const emailAttendeesForm = document.querySelector('#emailAttendeesModal form');
        if (emailAttendeesForm) {
            emailAttendeesForm.addEventListener('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                this.classList.add('was-validated');
            });
        }
    });
</script>
{% endblock %}
{% extends "organizer/base.html" %}

{% block title %}Organizer Dashboard{% endblock %}

{% block page_title %}Organizer Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Page Header -->
    <div class="card border-0 shadow-sm mb-2">
        <div class="card-body py-1">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 fs-4">Welcome back!</h2>
                    <p class="text-muted small mb-0">Here's what's happening with your events today.</p>
                </div>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3">{{ today_date }}</span>
                    <a href="{% url 'create_event' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Create Event
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-2 mb-2">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-2 d-flex align-items-center justify-content-center animate__animated animate__bounceIn" style="width: 48px; height: 48px; animation-delay: 0.5s">
                                <i class="fas fa-calendar-alt fa-lg text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h3 class="h4 mb-0 fw-bold animate__animated animate__fadeIn" style="animation-delay: 0.7s">{{ total_events_count|default:"0" }}</h3>
                            <p class="text-muted small mb-0 animate__animated animate__fadeIn" style="animation-delay: 0.8s">Total Events</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <div class="rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center animate__animated animate__bounceIn" style="width: 48px; height: 48px; animation-delay: 0.6s">
                                <i class="fas fa-users fa-lg text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h3 class="h4 mb-0 fw-bold animate__animated animate__fadeIn" style="animation-delay: 0.8s">{{ total_attendees_count|default:"0" }}</h3>
                            <p class="text-muted small mb-0 animate__animated animate__fadeIn" style="animation-delay: 0.9s">Total Attendees</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.3s">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <div class="rounded-circle bg-info bg-opacity-10 p-2 d-flex align-items-center justify-content-center animate__animated animate__bounceIn" style="width: 48px; height: 48px; animation-delay: 0.7s">
                                <i class="fas fa-user-tie fa-lg text-info"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h3 class="h4 mb-0 fw-bold animate__animated animate__fadeIn" style="animation-delay: 0.9s">{{ total_speakers_count|default:"0" }}</h3>
                            <p class="text-muted small mb-0 animate__animated animate__fadeIn" style="animation-delay: 1s">Total Speakers</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInUp" style="animation-delay: 0.4s">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <div class="rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center animate__animated animate__bounceIn" style="width: 48px; height: 48px; animation-delay: 0.8s">
                                <i class="fas fa-handshake fa-lg text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h3 class="h4 mb-0 fw-bold animate__animated animate__fadeIn" style="animation-delay: 1s">{{ total_sponsors_count|default:"0" }}</h3>
                            <p class="text-muted small mb-0 animate__animated animate__fadeIn" style="animation-delay: 1.1s">Total Sponsors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Events -->
    <div class="row g-2">
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm animate__animated animate__fadeInUp" style="animation-delay: 0.5s">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-2">
                    <h5 class="card-title mb-0 fs-5 fw-bold animate__animated animate__fadeInLeft" style="animation-delay: 0.7s">
                        <i class="fas fa-calendar-check me-2 text-primary animate__animated animate__heartBeat" style="animation-delay: 1.2s"></i>Upcoming Events
                    </h5>
                    <a href="{% url 'create_event' %}" class="btn btn-sm btn-outline-primary animate__animated animate__fadeInRight" style="animation-delay: 0.7s">
                        <i class="fas fa-plus me-1"></i> Add Event
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if upcoming_events %}
                        <div class="table-responsive animate__animated animate__fadeIn" style="animation-delay: 0.9s">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr class="animate__animated animate__fadeInDown" style="animation-delay: 1s">
                                        <th class="py-2">Event Title</th>
                                        <th class="py-2">Start Date</th>
                                        <th class="py-2">Description</th>
                                        <th class="py-2">Location</th>
                                        <th class="py-2">Attendees</th>
                                        <th class="py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in upcoming_events %}
                                    <tr class="animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter|add:"1" }}00ms">
                                        <td class="py-2">
                                            <div class="d-flex align-items-center">
                                                {% if event.banner %}
                                                    <img src="{{ event.banner.url }}" alt="{{ event.title }}" class="me-2 rounded" style="width: 32px; height: 32px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light me-2 rounded d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                        <i class="fas fa-calendar-alt text-primary"></i>
                                                    </div>
                                                {% endif %}
                                                <span>{{ event.title }}</span>
                                            </div>
                                        </td>
                                        <td class="py-2">{{ event.start_date|date:"M d, Y" }}</td>
                                        <td class="py-2">{{ event.description|truncatechars:50 }}</td>
                                        <td class="py-2">{{ event.location }}</td>
                                        <td class="py-2"><span class="badge bg-primary">{{ event.attendee_count }}</span></td>
                                        <td class="py-2">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'event_detail' event.event_id %}" class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                                <a href="{% url 'edit_event' event.event_id %}" class="btn btn-outline-info">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-calendar-1693591-1442634.png" alt="No Events" width="48" class="mb-2 opacity-50">
                            <h6 class="text-muted mb-1">No upcoming events</h6>
                            <p class="small text-muted mb-0">Create your first event to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics and Charts -->
    <div class="row g-2 mt-2">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInLeft" style="animation-delay: 0.6s">
                <div class="card-header bg-white border-0 py-2">
                    <h5 class="card-title mb-0 fs-5 fw-bold">
                        <i class="fas fa-chart-line me-2 text-primary"></i>Registration Trends
                    </h5>
                </div>
                <div class="card-body py-2">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="registrationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100 animate__animated animate__fadeInRight" style="animation-delay: 0.7s">
                <div class="card-header bg-white border-0 py-2">
                    <h5 class="card-title mb-0 fs-5 fw-bold">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Category Distribution
                    </h5>
                </div>
                <div class="card-body py-2">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Registrations -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-0 shadow animate__animated animate__fadeInUp" style="animation-delay: 0.8s">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0 fw-bold animate__animated animate__fadeInLeft" style="animation-delay: 1.4s">
                        <i class="fas fa-user-plus me-2 text-primary animate__animated animate__swing" style="animation-delay: 1.7s"></i>Recent Registrations
                    </h5>
                    <a href="{% url 'all_registrations' %}" class="btn btn-sm btn-outline-primary animate__animated animate__fadeInRight" style="animation-delay: 1.4s">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_registrations %}
                        <div class="table-responsive animate__animated animate__fadeIn" style="animation-delay: 1.6s">
                            <table class="table table-hover">
                                <thead>
                                    <tr class="animate__animated animate__fadeInDown" style="animation-delay: 1.7s">
                                        <th>User</th>
                                        <th>Registration Date</th>
                                        <th>Event</th>
                                        <th>Role</th>
                                        <th>Attendee Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reg in recent_registrations %}
                                    <tr class="animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter|add:"18" }}00ms">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-light me-2 rounded-circle d-flex align-items-center justify-content-center animate__animated animate__pulse animate__infinite animate__slower" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-user text-primary"></i>
                                                </div>
                                                <span>{{ reg.user.get_full_name }}</span>
                                            </div>
                                        </td>
                                        <td>{{ reg.registered_at|date:"M d, Y" }}</td>
                                        <td>{{ reg.event.title }}</td>
                                        <td>
                                            <span class="badge {% if reg.role.name == 'attendee' %}bg-primary{% elif reg.role.name == 'speaker' %}bg-success{% else %}bg-warning{% endif %} animate__animated animate__pulse animate__infinite">
                                                {{ reg.role.name|title }}
                                            </span>
                                        </td>
                                        <td>{{ reg.attendee_type.name|default:"-"|title }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5 animate__animated animate__fadeIn" style="animation-delay: 1.6s">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-data-not-found-1965034-1662569.png" alt="No Data" width="80" class="animate__animated animate__pulse animate__infinite animate__slower">
                            <p class="mt-3 text-muted animate__animated animate__fadeIn" style="animation-delay: 1.8s">No recent registrations found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Feedback -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card border-0 shadow animate__animated animate__fadeInUp" style="animation-delay: 0.9s">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0 fw-bold animate__animated animate__fadeInLeft" style="animation-delay: 1.9s">
                        <i class="fas fa-comment-alt me-2 text-primary animate__animated animate__swing" style="animation-delay: 2.1s"></i>Recent Feedback
                    </h5>
                    <a href="{% url 'all_feedback' %}" class="btn btn-sm btn-outline-primary animate__animated animate__fadeInRight" style="animation-delay: 1.9s">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_feedback %}
                        <div class="table-responsive animate__animated animate__fadeIn" style="animation-delay: 2s">
                            <table class="table table-hover">
                                <thead>
                                    <tr class="animate__animated animate__fadeInDown" style="animation-delay: 2.1s">
                                        <th>Event</th>
                                        <th>User</th>
                                        <th>Rating</th>
                                        <th>Comment</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for feedback in recent_feedback %}
                                    <tr class="animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter|add:"22" }}00ms">
                                        <td>{{ feedback.event.title }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-light me-2 rounded-circle d-flex align-items-center justify-content-center animate__animated animate__pulse animate__infinite animate__slower" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-user text-primary"></i>
                                                </div>
                                                <span>{{ feedback.user.get_full_name }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= feedback.rating %}
                                                    <i class="fas fa-star text-warning animate__animated animate__pulse animate__infinite" style="animation-delay: {{ forloop.counter|add:"0." }}s"></i>
                                                {% else %}
                                                    <i class="far fa-star text-muted"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{{ feedback.comments|truncatechars:100 }}</td>
                                        <td>{{ feedback.feedback_id|date:"M d, Y" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5 animate__animated animate__fadeIn" style="animation-delay: 2s">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-chat-bubble-3114776-2598188.png" alt="No Feedback" width="80" class="animate__animated animate__pulse animate__infinite animate__slower">
                            <p class="mt-3 text-muted animate__animated animate__fadeIn" style="animation-delay: 2.2s">No feedback received yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Registration Chart
        var regCtx = document.getElementById('registrationChart').getContext('2d');
        var regChart = new Chart(regCtx, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ registration_dates|escapejs }}'),
                datasets: [{
                    label: 'Registrations',
                    data: JSON.parse('{{ registration_counts|escapejs }}'),
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Category Chart
        var catCtx = document.getElementById('categoryChart').getContext('2d');
        var catChart = new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: JSON.parse('{{ category_labels|escapejs }}'),
                datasets: [{
                    data: JSON.parse('{{ category_data|escapejs }}'),
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.7)',
                        'rgba(28, 200, 138, 0.7)',
                        'rgba(54, 185, 204, 0.7)',
                        'rgba(246, 194, 62, 0.7)',
                        'rgba(231, 74, 59, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    }
                },
                cutout: '70%'
            }
        });
    });
</script>
{% endblock %}